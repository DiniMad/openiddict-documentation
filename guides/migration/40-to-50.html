<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Migrate to OpenIddict 5.0 </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Migrate to OpenIddict 5.0 ">
    <meta name="generator" content="docfx 2.56.7.0">
    
    <link rel="shortcut icon" href="../../images/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css">
    <link rel="stylesheet" href="../../styles/colors.css">
    <link rel="stylesheet" href="../../styles/discord.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>

  <body>
        <div class="top-navbar">

            <a href="javascript:void(0);" class="burger-icon" onclick="toggleMenu()">
                <svg name="Hamburger" style="vertical-align: middle;" width="24" height="24" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M20 6H4V9H20V6ZM4 10.999H20V13.999H4V10.999ZM4 15.999H20V18.999H4V15.999Z"></path></svg>
            </a>

            
            <a class="brand" href="../../index.html">
              <img src="../../images/logo.png" alt="OpenIddict" class="logomark">
              <span class="brand-title">OpenIddict</span>
            </a>
        </div>

        <div class="body-content">

            <div id="blackout" class="blackout" onclick="toggleMenu()"></div>

            <nav id="sidebar" role="navigation">

                <div class="sidebar">
                    
                    
                    
                    
                    <div>
                      
                      <a class="brand" href="../../index.html">
                        <img src="../../images/logo.png" alt="OpenIddict" class="logomark">
                        <span class="brand-title">OpenIddict</span>
                      </a>
                      <div id="navbar">
                    
                      </div>
                    
                    </div>


                    <div class="sidebar-item-separator"></div>

                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>

                </div>

                <div class="footer">
                  
                  <span>Generated by <strong>DocFX</strong></span>
                </div>
            </nav>

            <main class="main-panel">

                <div role="main" class="hide-when-search">

                        
                        <div class="subnav navbar navbar-default">
                          <div class="container hide-when-search" id="breadcrumb">
                            <ul class="breadcrumb">
                              <li></li>
                            </ul>
                          </div>
                        </div>

                    <article class="content wrap" id="_content" data-uid="">
<h1 id="migrate-to-openiddict-50">Migrate to OpenIddict 5.0</h1>

<h2 id="whats-new">What&#39;s new?</h2>
<p>The most important changes introduced in 5.0 can be found <a href="https://kevinchalet.com/2023/12/18/openiddict-5-0-general-availability/">here</a>.</p>
<div class="NOTE"><h5>Note</h5><p><strong>Migrating to OpenIddict 5.0 requires making changes to your database</strong>: existing properties have been reworked and new ones have been added to support the new features.</p>
</div>
<h2 id="update-your-packages-references">Update your packages references</h2>
<p>For that, update your <code>.csproj</code> file to reference the <code>OpenIddict</code> 5.x packages. For instance:</p>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
  &lt;!-- OpenIddict 4.x: --&gt;
  &lt;PackageReference Include=&quot;OpenIddict.AspNetCore&quot; Version=&quot;4.10.1&quot; /&gt;
  &lt;PackageReference Include=&quot;OpenIddict.EntityFrameworkCore&quot; Version=&quot;4.10.1&quot; /&gt;

  &lt;!-- OpenIddict 5.x: --&gt;
  &lt;PackageReference Include=&quot;OpenIddict.AspNetCore&quot; Version=&quot;5.3.0&quot; /&gt;
  &lt;PackageReference Include=&quot;OpenIddict.EntityFrameworkCore&quot; Version=&quot;5.3.0&quot; /&gt;
&lt;/ItemGroup&gt;
</code></pre><div class="NOTE"><h5>Note</h5><p>Migrating to ASP.NET Core 8.0 is not required, as OpenIddict 5.0 is still natively compatible with ASP.NET Core 2.1 (.NET Framework-only),
ASP.NET Core 6.0 and ASP.NET Core 7.0. Moving to a newer .NET runtime or ASP.NET Core can be done separately for a simpler/decoupled upgrade:</p>
<table>
<thead>
<tr>
<th>Web framework version</th>
<th>.NET runtime version</th>
</tr>
</thead>
<tbody>
<tr>
<td>ASP.NET Core 2.1</td>
<td>.NET Framework 4.6.1</td>
</tr>
<tr>
<td>ASP.NET Core 2.1</td>
<td>.NET Framework 4.7.2</td>
</tr>
<tr>
<td>ASP.NET Core 2.1</td>
<td>.NET Framework 4.8</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>ASP.NET Core 6.0</td>
<td>.NET 6.0</td>
</tr>
<tr>
<td>ASP.NET Core 7.0</td>
<td>.NET 7.0</td>
</tr>
<tr>
<td>ASP.NET Core 8.0</td>
<td>.NET 8.0</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>Microsoft.Owin 4.2</td>
<td>.NET Framework 4.6.1</td>
</tr>
<tr>
<td>Microsoft.Owin 4.2</td>
<td>.NET Framework 4.7.2</td>
</tr>
<tr>
<td>Microsoft.Owin 4.2</td>
<td>.NET Framework 4.8</td>
</tr>
</tbody>
</table>
</div>
<h2 id="use-openiddictapplicationdescriptorclienttype-instead-of-openiddictapplicationdescriptortype">Use <code>OpenIddictApplicationDescriptor.ClientType</code> instead of <code>OpenIddictApplicationDescriptor.Type</code></h2>
<p>To avoid confusion with the new <code>OpenIddictApplicationDescriptor.ApplicationType</code> property, the existing <code>OpenIddictApplicationDescriptor.Type</code>
property was replaced by a new <code>OpenIddictApplicationDescriptor.ClientType</code> property. The old property is still present but is obsolete and will
be removed in the next major version.</p>
<pre><code class="lang-csharp">await manager.CreateAsync(new OpenIddictApplicationDescriptor
{
    ClientId = &quot;mvc&quot;,
    ClientSecret = &quot;901564A5-E7FE-42CB-B10D-61EF6A8F3654&quot;,

    // Before:
    Type = ClientTypes.Confidential

    // After:
    ClientType = ClientTypes.Confidential
});
</code></pre><h2 id="if-applicable-add-and-apply-migrations">If applicable, add and apply migrations</h2>
<p>If your application uses Entity Framework Core or Entity Framework 6, add a migration to react to the schema changes listed below and apply it.</p>
<h3 id="added-properties">Added properties</h3>
<table>
<thead>
<tr>
<th>Table</th>
<th>Column name</th>
<th>Type</th>
<th>Nullable</th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenIddictApplications</td>
<td>ApplicationType</td>
<td>string</td>
<td>Yes</td>
</tr>
<tr>
<td>OpenIddictApplications</td>
<td>JsonWebKeySet</td>
<td>string</td>
<td>Yes</td>
</tr>
<tr>
<td>OpenIddictApplications</td>
<td>Settings</td>
<td>string</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h3 id="renamed-properties">Renamed properties</h3>
<table>
<thead>
<tr>
<th>Table</th>
<th>Old column name</th>
<th>New column name</th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenIddictApplications</td>
<td>Type</td>
<td>ClientType</td>
</tr>
</tbody>
</table>
<h2 id="if-applicable-update-your-openiddict-mongodb-applications">If applicable, update your OpenIddict MongoDB applications</h2>
<p>To avoid confusion with the new <code>OpenIddictMongoDbApplication.ApplicationType</code> property, the existing <code>OpenIddictMongoDbApplication.Type</code>
property was renamed to <code>OpenIddictMongoDbApplication.ClientType</code> (<code>client_type</code> in the BSON schema). To ensure the existing applications
are correctly updated to use the new name, the following script can be used to update all the existing applications at once very efficiently:</p>
<pre><code class="lang-csharp">using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using MongoDB.Bson;
using MongoDB.Driver;
using OpenIddict.MongoDb;

var services = new ServiceCollection();
services.AddOpenIddict()
    .AddCore()
    .UseMongoDb()
    .UseDatabase(new MongoClient(&quot;mongodb://localhost:27017&quot;).GetDatabase(&quot;openiddict&quot;));

await using var provider = services.BuildServiceProvider();
var context = provider.GetRequiredService&lt;IOpenIddictMongoDbContext&gt;();
var options = provider.GetRequiredService&lt;IOptionsMonitor&lt;OpenIddictMongoDbOptions&gt;&gt;().CurrentValue;
var database = await context.GetDatabaseAsync(CancellationToken.None);

var applications = database.GetCollection&lt;BsonDocument&gt;(options.ApplicationsCollectionName);
await applications.UpdateManyAsync(
    filter: Builders&lt;BsonDocument&gt;.Filter.Empty,
    update: Builders&lt;BsonDocument&gt;.Update.Rename(&quot;type&quot;, &quot;client_type&quot;));
</code></pre><h2 id="if-applicable-update-your-custom-stores-to-implement-the-new-apis">If applicable, update your custom stores to implement the new APIs</h2>
<p>To support the new features introduced in 5.0, new store APIs have been added to <code>IOpenIddictApplicationStore</code> and will need to be implemented:</p>
<pre><code class="lang-csharp">ValueTask&lt;string?&gt; GetApplicationTypeAsync(TApplication application, CancellationToken cancellationToken);
ValueTask&lt;JsonWebKeySet?&gt; GetJsonWebKeySetAsync(TApplication application, CancellationToken cancellationToken);
ValueTask&lt;ImmutableDictionary&lt;string, string&gt;&gt; GetSettingsAsync(TApplication application, CancellationToken cancellationToken);
ValueTask SetApplicationTypeAsync(TApplication application, string? type, CancellationToken cancellationToken);
ValueTask SetJsonWebKeySetAsync(TApplication application, JsonWebKeySet? set, CancellationToken cancellationToken);
ValueTask SetSettingsAsync(TApplication application, ImmutableDictionary&lt;string, string&gt; settings, CancellationToken cancellationToken);
</code></pre><p>A new API has also been added to <code>IOpenIddictTokenStore</code>:</p>
<pre><code class="lang-csharp">ValueTask&lt;long&gt; RevokeByAuthorizationIdAsync(string identifier, CancellationToken cancellationToken);
</code></pre><p>The <code>PruneAsync(DateTimeOffset threshold, CancellationToken cancellationToken)</code> API present in both
<code>IOpenIddictAuthorizationStore</code> and <code>IOpenIddictTokenStore</code> has also been updated to return the number of removed entries:</p>
<pre><code class="lang-csharp">// OpenIddict 4.x:
ValueTask PruneAsync(DateTimeOffset threshold, CancellationToken cancellationToken);

// OpenIddict 5.x:
ValueTask&lt;long&gt; PruneAsync(DateTimeOffset threshold, CancellationToken cancellationToken);
</code></pre><h2 id="consider-using-client-assertions-optional">Consider using client assertions (optional)</h2>
<p>OpenIddict 5.0 introduces native support for client assertions in the server and validation stacks (client assertions were already
supported by the client stack in OpenIddict 4.0). Client assertions offer a more secure alternative to client secrets and are now
the recommended way for confidential applications to authenticate in OpenIddict 5.0.</p>
<p>For more information, read <a href="https://kevinchalet.com/2023/12/18/openiddict-5-0-general-availability/">OpenIddict 5.0 general availability</a>.</p>
</article>
              
                </div>
            </main>
        </div>

        
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<script type="text/javascript" src="../../styles/jquery.twbsPagination.js"></script>
<script type="text/javascript" src="../../styles/url.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<script type="text/javascript" src="../../styles/docfx.js"></script>
<script type="text/javascript" src="../../styles/main.js"></script>

    </body>

</html>
